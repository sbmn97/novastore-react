pipeline {
    agent any
    options { timestamps() }
    
    environment {
        SITE_DIR = 'src'
        BUILD_DIR = 'build'
        DEPLOY_DIR = '/var/www/site'
        GITHUB_REPO = 'https://github.com/sbmn97/novastore-react.git'
    }
    
    stages {
        stage('Checkout') {
            steps { 
                checkout scm
                echo '‚úÖ Source code retrieved successfully'
            }
        }
        
        stage('Validate') {
            steps {
                script {
                    // Use Docker to run Node.js commands (more reliable)
                    sh '''
                        echo "üìã Environment Information:"
                        docker run --rm -v $(pwd):/workspace -w /workspace node:18-alpine sh -c "
                            node --version
                            npm --version
                        "
                        echo "‚úÖ Environment validation complete"
                    '''
                }
            }
        }
        
        stage('Install & Build') {
            steps {
                script {
                    sh '''
                        echo "üì¶ Installing dependencies and building..."
                        docker run --rm -v $(pwd):/workspace -w /workspace node:18-alpine sh -c "
                            set -euo pipefail
                            echo 'üì¶ Installing dependencies...'
                            npm ci
                            echo 'üèóÔ∏è Building React application...'
                            npm run build
                            echo '‚úÖ Build completed successfully'
                        "
                    '''
                }
            }
        }
        
        stage('Package') {
            steps {
                sh '''
                    set -euo pipefail
                    echo "üìÅ Packaging build artifacts..."
                    # Ensure build directory exists
                    if [ ! -d "build" ]; then
                        echo "‚ùå Build failed - no build directory found"
                        exit 1
                    fi
                    echo "üìä Build contents:"
                    ls -la build/
                '''
                archiveArtifacts artifacts: "${BUILD_DIR}/**", fingerprint: true
            }
        }
        
        stage('Deploy to Nginx') {
            steps {
                sh '''
                    set -euo pipefail
                    echo "üöÄ Deploying to Nginx web server..."
                    mkdir -p "${DEPLOY_DIR}"
                    rm -rf "${DEPLOY_DIR:?}/"*
                    cp -r "${BUILD_DIR}/." "${DEPLOY_DIR}/"
                    echo "‚úÖ Deployment completed successfully"
                '''
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup with proper context
                try {
                    echo 'üßπ Cleaning up workspace...'
                    sh '''
                        # Remove node_modules to save space (can be reinstalled)
                        rm -rf node_modules || true
                        echo "Cleanup completed"
                    '''
                } catch (Exception e) {
                    echo "Cleanup warning: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo 'üéâ NovaStore deployment successful!'
            echo 'Deployed. Open http://localhost:8081'
        }
        
        failure {
            echo '‚ùå Pipeline failed. Check logs for details.'
        }
    }
}